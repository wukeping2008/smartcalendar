\n'use client'\n\nimport { Event, EventCategory, Priority, EnergyLevel } from '../../types/event'\n\n/**\n * AIæœåŠ¡ - æ™ºèƒ½æ—¥ç¨‹ç®¡ç†æ ¸å¿ƒå¼•æ“\n * åŒ…å«ï¼šä¹ æƒ¯å­¦ä¹ ã€æ™ºèƒ½æé†’ã€å†²çªè§£å†³ã€ä¼˜åŒ–æ¨è\n */\n\n// AIå­¦ä¹ çš„ç”¨æˆ·ä¹ æƒ¯æ•°æ®\ninterface UserHabits {\n  // æ—¶é—´åå¥½\n  preferredWorkingHours: { start: number; end: number }\n  peakEnergyHours: number[]\n  lowEnergyHours: number[]\n  \n  // ç±»åˆ«åå¥½\n  categoryFrequency: Record<EventCategory, number>\n  categoryDurations: Record<EventCategory, number>\n  categoryPriorities: Record<EventCategory, Priority>\n  \n  // è¡Œä¸ºæ¨¡å¼\n  averageEventDuration: number\n  bufferTimePreference: number // äº‹ä»¶é—´éš”åå¥½\n  multitaskingCapability: number // å¤šä»»åŠ¡å¤„ç†èƒ½åŠ›è¯„åˆ†\n  \n  // çµæ´»æ€§\n  reschedulingPatterns: {\n    category: EventCategory\n    flexibility: number\n    frequentChanges: boolean\n  }[]\n}\n\n// AIåˆ†æç»“æœ\ninterface AIAnalysis {\n  habitScore: number // ä¹ æƒ¯åŒ¹é…åº¦\n  energyAlignment: number // ç²¾åŠ›åŒ¹é…åº¦\n  conflictRisk: number // å†²çªé£é™©\n  optimizationScore: number // ä¼˜åŒ–å¾—åˆ†\n  recommendations: AIRecommendation[]\n}\n\n// AIæ¨è\ninterface AIRecommendation {\n  type: 'time_adjustment' | 'energy_optimization' | 'conflict_resolution' | 'habit_improvement'\n  title: string\n  description: string\n  impact: 'high' | 'medium' | 'low'\n  confidence: number\n  action?: string\n}\n\nclass AIService {\n  private userHabits: UserHabits\n  private learningData: Event[] = []\n  private analysisCache: Map<string, AIAnalysis> = new Map()\n\n  constructor() {\n    // åˆå§‹åŒ–é»˜è®¤ç”¨æˆ·ä¹ æƒ¯\n    this.userHabits = {\n      preferredWorkingHours: { start: 9, end: 17 },\n      peakEnergyHours: [9, 10, 11, 14, 15],\n      lowEnergyHours: [13, 16, 17, 18],\n      categoryFrequency: {\n        [EventCategory.WORK]: 5,\n        [EventCategory.MEETING]: 3,\n        [EventCategory.PERSONAL]: 2,\n        [EventCategory.BREAK]: 4,\n        [EventCategory.EXERCISE]: 1,\n        [EventCategory.MEAL]: 3,\n        [EventCategory.TRAVEL]: 1,\n        [EventCategory.TRADING]: 8,\n        [EventCategory.LIFE_ROUTINE]: 4,\n        [EventCategory.PREPARATION]: 2,\n        [EventCategory.OTHER]: 1\n      },\n      categoryDurations: {\n        [EventCategory.WORK]: 120,\n        [EventCategory.MEETING]: 60,\n        [EventCategory.PERSONAL]: 90,\n        [EventCategory.BREAK]: 15,\n        [EventCategory.EXERCISE]: 45,\n        [EventCategory.MEAL]: 45,\n        [EventCategory.TRAVEL]: 30,\n        [EventCategory.TRADING]: 5,\n        [EventCategory.LIFE_ROUTINE]: 30,\n        [EventCategory.PREPARATION]: 20,\n        [EventCategory.OTHER]: 60\n      },\n      categoryPriorities: {\n        [EventCategory.WORK]: Priority.HIGH,\n        [EventCategory.MEETING]: Priority.HIGH,\n        [EventCategory.PERSONAL]: Priority.MEDIUM,\n        [EventCategory.BREAK]: Priority.LOW,\n        [EventCategory.EXERCISE]: Priority.MEDIUM,\n        [EventCategory.MEAL]: Priority.MEDIUM,\n        [EventCategory.TRAVEL]: Priority.LOW,\n        [EventCategory.TRADING]: Priority.URGENT,\n        [EventCategory.LIFE_ROUTINE]: Priority.MEDIUM,\n        [EventCategory.PREPARATION]: Priority.HIGH,\n        [EventCategory.OTHER]: Priority.LOW\n      },\n      averageEventDuration: 60,\n      bufferTimePreference: 15,\n      multitaskingCapability: 0.7,\n      reschedulingPatterns: [\n        { category: EventCategory.TRADING, flexibility: 20, frequentChanges: false },\n        { category: EventCategory.MEETING, flexibility: 30, frequentChanges: false },\n        { category: EventCategory.PERSONAL, flexibility: 80, frequentChanges: true }\n      ]\n    }\n  }\n\n  /**\n   * å­¦ä¹ ç”¨æˆ·ä¹ æƒ¯\n   */\n  learnFromEvents(events: Event[]): void {\n    this.learningData = events\n    this.updateHabitsFromData(events)\n    console.log('ğŸ§  AIå­¦ä¹ å®Œæˆ:', this.userHabits)\n  }\n\n  private updateHabitsFromData(events: Event[]): void {\n    if (events.length === 0) return\n\n    // åˆ†æå·¥ä½œæ—¶é—´åå¥½\n    const workEvents = events.filter(e => \n      e.category === EventCategory.WORK || e.category === EventCategory.MEETING\n    )\n    \n    if (workEvents.length > 0) {\n      const workingHours = workEvents.map(e => e.startTime.getHours())\n      const minHour = Math.min(...workingHours)\n      const maxHour = Math.max(...workingHours)\n      \n      this.userHabits.preferredWorkingHours = {\n        start: Math.max(6, minHour - 1),\n        end: Math.min(22, maxHour + 2)\n      }\n    }\n\n    // åˆ†æç±»åˆ«é¢‘ç‡\n    const categoryCount: Partial<Record<EventCategory, number>> = {}\n    events.forEach(event => {\n      categoryCount[event.category] = (categoryCount[event.category] || 0) + 1\n    })\n\n    Object.entries(categoryCount).forEach(([category, count]) => {\n      this.userHabits.categoryFrequency[category as EventCategory] = count || 0\n    })\n\n    // åˆ†æå¹³å‡äº‹ä»¶æ—¶é•¿\n    const durations = events.map(e => e.estimatedDuration)\n    this.userHabits.averageEventDuration = durations.reduce((a, b) => a + b, 0) / durations.length || 60\n  }\n\n  /**\n   * æ™ºèƒ½åˆ†æäº‹ä»¶\n   */\n  analyzeEvent(event: Event, context: Event[]): AIAnalysis {\n    const cacheKey = `${event.id}-${context.length}`\n    if (this.analysisCache.has(cacheKey)) {\n      return this.analysisCache.get(cacheKey)!\n    }\n\n    const analysis: AIAnalysis = {\n      habitScore: this.calculateHabitScore(event),\n      energyAlignment: this.calculateEnergyAlignment(event),\n      conflictRisk: this.calculateConflictRisk(event, context),\n      optimizationScore: 0,\n      recommendations: []\n    }\n\n    analysis.optimizationScore = (\n      analysis.habitScore * 0.3 + \n      analysis.energyAlignment * 0.3 + \n      (1 - analysis.conflictRisk) * 0.4\n    )\n\n    analysis.recommendations = this.generateRecommendations(event, context, analysis)\n\n    this.analysisCache.set(cacheKey, analysis)\n    return analysis\n  }\n\n  private calculateHabitScore(event: Event): number {\n    const hour = event.startTime.getHours()\n    const { start, end } = this.userHabits.preferredWorkingHours\n    \n    // æ—¶é—´åŒ¹é…åº¦\n    let timeScore = 1.0\n    if (event.category === EventCategory.WORK || event.category === EventCategory.MEETING) {\n      timeScore = (hour >= start && hour <= end) ? 1.0 : 0.3\n    }\n\n    // æ—¶é•¿åŒ¹é…åº¦\n    const expectedDuration = this.userHabits.categoryDurations[event.category]\n    const durationScore = Math.max(0.1, 1 - Math.abs(event.estimatedDuration - expectedDuration) / expectedDuration)\n\n    return (timeScore * 0.6 + durationScore * 0.4)\n  }\n\n  private calculateEnergyAlignment(event: Event): number {\n    const hour = event.startTime.getHours()\n    const isHighEnergyRequired = event.energyRequired === EnergyLevel.PEAK || event.energyRequired === EnergyLevel.HIGH\n    const isPeakHour = this.userHabits.peakEnergyHours.includes(hour)\n    const isLowHour = this.userHabits.lowEnergyHours.includes(hour)\n\n    if (isHighEnergyRequired && isPeakHour) return 1.0\n    if (isHighEnergyRequired && isLowHour) return 0.2\n    if (!isHighEnergyRequired && isLowHour) return 0.8\n    if (!isHighEnergyRequired && isPeakHour) return 0.6\n    \n    return 0.7 // ä¸­æ€§åŒ¹é…\n  }\n\n  private calculateConflictRisk(event: Event, context: Event[]): number {\n    const conflicts = context.filter(existing => \n      existing.id !== event.id &&\n      this.eventsOverlap(event, existing)\n    )\n\n    if (conflicts.length === 0) return 0\n\n    // è€ƒè™‘å†²çªçš„ä¸¥é‡ç¨‹åº¦\n    const severeConflicts = conflicts.filter(c => \n      c.priority === Priority.URGENT || c.isMarketProtected\n    )\n\n    return Math.min(1, conflicts.length * 0.3 + severeConflicts.length * 0.4)\n  }\n\n  private eventsOverlap(event1: Event, event2: Event): boolean {\n    return event1.startTime < event2.endTime && event2.startTime < event1.endTime\n  }\n\n  private generateRecommendations(event: Event, context: Event[], analysis: AIAnalysis): AIRecommendation[] {\n    const recommendations: AIRecommendation[] = []\n\n    // æ—¶é—´è°ƒæ•´å»ºè®®\n    if (analysis.habitScore < 0.6) {\n      recommendations.push({\n        type: 'time_adjustment',\n        title: 'æ—¶é—´å®‰æ’ä¼˜åŒ–',\n        description: `å»ºè®®å°†\"${event.title}\"è°ƒæ•´åˆ°${this.getSuggestedTimeSlot(event)}`,\n        impact: 'medium',\n        confidence: 0.8,\n        action: 'reschedule'\n      })\n    }\n\n    // ç²¾åŠ›ä¼˜åŒ–å»ºè®®\n    if (analysis.energyAlignment < 0.5) {\n      const energyTip = event.energyRequired === EnergyLevel.PEAK \n        ? 'å»ºè®®å®‰æ’åœ¨ä¸Šåˆ9-11ç‚¹æˆ–ä¸‹åˆ2-3ç‚¹çš„é«˜ç²¾åŠ›æ—¶æ®µ'\n        : 'å¯ä»¥å®‰æ’åœ¨ä¸‹åˆ1ç‚¹æˆ–å‚æ™šçš„ä½ç²¾åŠ›æ—¶æ®µ'\n      \n      recommendations.push({\n        type: 'energy_optimization',\n        title: 'ç²¾åŠ›åŒ¹é…ä¼˜åŒ–',\n        description: energyTip,\n        impact: 'high',\n        confidence: 0.9\n      })\n    }\n\n    // å†²çªè§£å†³å»ºè®®\n    if (analysis.conflictRisk > 0.3) {\n      recommendations.push({\n        type: 'conflict_resolution',\n        title: 'æ—¶é—´å†²çªå¤„ç†',\n        description: 'æ£€æµ‹åˆ°æ—¶é—´å†²çªï¼Œå»ºè®®é‡æ–°å®‰æ’æˆ–ç¼©çŸ­äº‹ä»¶æ—¶é•¿',\n        impact: 'high',\n        confidence: 0.95,\n        action: 'resolve_conflict'\n      })\n    }\n\n    // ä¹ æƒ¯æ”¹è¿›å»ºè®®\n    if (analysis.optimizationScore > 0.8) {\n      recommendations.push({\n        type: 'habit_improvement',\n        title: 'ä¼˜ç§€å®‰æ’',\n        description: 'è¿™ä¸ªæ—¶é—´å®‰æ’å¾ˆç¬¦åˆæ‚¨çš„ä¹ æƒ¯ï¼Œå»ºè®®ä¿æŒï¼',\n        impact: 'low',\n        confidence: 0.9\n      })\n    }\n\n    return recommendations\n  }\n\n  private getSuggestedTimeSlot(event: Event): string {\n    const { start, end } = this.userHabits.preferredWorkingHours\n    \n    if (event.category === EventCategory.TRADING) {\n      return 'æ•´ç‚¹æ—¶é—´ï¼ˆå¦‚9:00, 10:00, 11:00ï¼‰'\n    }\n    \n    if (event.energyRequired === EnergyLevel.PEAK) {\n      return `ä¸Šåˆ${Math.max(9, start)}:00-11:00 æˆ–ä¸‹åˆ14:00-15:00`\n    }\n    \n    return `å·¥ä½œæ—¶é—´å†… ${start}:00-${end}:00`\n  }\n\n  /**\n   * æ™ºèƒ½æé†’ç³»ç»Ÿ\n   */\n  generateSmartReminders(event: Event): Array<{\n    time: Date\n    message: string\n    type: 'preparation' | 'energy' | 'conflict' | 'habit'\n  }>
